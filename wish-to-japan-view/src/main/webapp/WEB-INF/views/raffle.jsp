<div class="bg-awan">
  <div class="transparant"></div>

  <div id='slot-holder'>
    <div class="time-wrapper" id="raffle-holder">
      <div class='jpn-wrapper'>
        <ul class='slot-fix'>
          <li>J</li>
          <li>P</li>
          <li>N</li>
        </ul>
      </div>
      <ul class="slot" id='unilever-slot'>
        <li>&nbsp;</li>
        <li>U</li>
        <li>&nbsp;</li>
        <li>U</li>
        <li>&nbsp;</li>
        <li>U</li>
      </ul>
      <div class='jpn-wrapper'>
        <ul class='slot-fix'>
          <li>&ndash;</li>
        </ul>
      </div>
      <ul class="slot" id='code-slot1'>
        <li><span>1</span></li>
        <li><span>2</span></li>
        <li><span>3</span></li>
        <li><span>4</span></li>
        <li><span>5</span></li>
        <li><span>6</span></li>
        <li><span>7</span></li>
        <li><span>8</span></li>
        <li><span>9</span></li>
        <li><span>0</span></li>
        <li><span>*</span></li>
        <li><span>A</span></li>
        <li><span>B</span></li>
        <li><span>C</span></li>
        <li><span>D</span></li>
        <li><span>E</span></li>
        <li><span>F</span></li>
        <li><span>G</span></li>
        <li><span>H</span></li>
        <li><span>I</span></li>
        <li><span>J</span></li>
        <li><span>K</span></li>
        <li><span>L</span></li>
        <li><span>M</span></li>
        <li><span>N</span></li>
        <li><span>O</span></li>
        <li><span>P</span></li>
        <li><span>Q</span></li>
        <li><span>R</span></li>
        <li><span>S</span></li>
        <li><span>T</span></li>
        <li><span>U</span></li>
        <li><span>V</span></li>
        <li><span>W</span></li>
        <li><span>X</span></li>
        <li><span>Y</span></li>
        <li><span>Z</span></li>
      </ul>
      <div class='jpn-wrapper'>
        <ul class='slot-fix'>
          <li>&ndash;</li>
        </ul>
      </div>
      <ul class="slot" id='code-slot2'>
        <li><span>1</span></li>
        <li><span>2</span></li>
        <li><span>3</span></li>
        <li><span>4</span></li>
        <li><span>5</span></li>
        <li><span>6</span></li>
        <li><span>7</span></li>
        <li><span>8</span></li>
        <li><span>9</span></li>
        <li><span>0</span></li>
        <li><span>*</span></li>
        <li><span>A</span></li>
        <li><span>B</span></li>
        <li><span>C</span></li>
        <li><span>D</span></li>
        <li><span>E</span></li>
        <li><span>F</span></li>
        <li><span>G</span></li>
        <li><span>H</span></li>
        <li><span>I</span></li>
        <li><span>J</span></li>
        <li><span>K</span></li>
        <li><span>L</span></li>
        <li><span>M</span></li>
        <li><span>N</span></li>
        <li><span>O</span></li>
        <li><span>P</span></li>
        <li><span>Q</span></li>
        <li><span>R</span></li>
        <li><span>S</span></li>
        <li><span>T</span></li>
        <li><span>U</span></li>
        <li><span>V</span></li>
        <li><span>W</span></li>
        <li><span>X</span></li>
        <li><span>Y</span></li>
        <li><span>Z</span></li>
      </ul>
    </div>

    <div class="time-wrapper hidden" id="congratulations-raffle-holder">
      <ul class="slot" id="congratulations-slot">
        <li><span>-</span></li>
        <li><span>A</span></li>
        <li><span>B</span></li>
        <li><span>C</span></li>
        <li><span>D</span></li>
        <li><span>E</span></li>
        <li><span>F</span></li>
        <li><span>G</span></li>
        <li><span>H</span></li>
        <li><span>I</span></li>
        <li><span>J</span></li>
        <li><span>K</span></li>
        <li><span>L</span></li>
        <li><span>M</span></li>
        <li><span>N</span></li>
        <li><span>O</span></li>
        <li><span>P</span></li>
        <li><span>Q</span></li>
        <li><span>R</span></li>
        <li><span>S</span></li>
        <li><span>T</span></li>
        <li><span>U</span></li>
        <li><span>V</span></li>
        <li><span>W</span></li>
        <li><span>X</span></li>
        <li><span>Y</span></li>
        <li><span>Z</span></li>
        <li><span>!</span></li>
      </ul>
    </div>
  </div>
  <h2 id='jpn-name-holder'>&nbsp;</h2>
</div>

<div id='action-box'>
  <div id='chosen-winner' class='hidden'>
    <p>
      <span id='chosen-winner-state'></span> pemenang Liburan GRATIS ke Jepang telah terpilih hari
      ini.
    </p>
  </div>
  <div id='running' class='hidden'>
    <p>
      Apakah Anda Pemenang Grand Prize Liburan GRATIS ke Jepang <span
      id='grand-prize-state'></span>?
    </p>
  </div>
  <div id='running-rerun' class='hidden'>
    <p>
      Masih ada kesempatan untuk menjadi pemenang Grand Prize Liburan GRATIS ke Jepang! Proses
      pengundian <span id='rerun-th'></span> akan diulang kembali,
      karena pemenang terpilih belum melakukan klaim hadiah.
    </p>
  </div>

  <div id='claiming' class='hidden'>
    <div class="hitungmundur" style="display: block;">
      <p>Klaim hadiah Anda sebelum</p>
      <p>
        <span id='claiming-countdown' class="countdown"></span>
      </p>
    </div>

    <div id='txt-claim-holder' class='hidden'>
      <input type="email" name="email" id='txt-claim' placeholder="MASUKKAN EMAIL ANDA">
    </div>
    <a class='btn' id='btn-claim'>KLAIM SEKARANG &blacktriangleright;</a>
  </div>

  <div id='claimed' class='hidden'>
    <div class="selamat-wrapper">
      <img src="_asset/images/image-globe.png">
      <h2>Selamat Anda memenangkan Grand Prize Liburan GRATIS ke Jepang</h2>
      <p>Customer Care kami akan segera menghubungi Anda untuk konfirmasi melalui telepon dan
        email
        dalam waktu 2x24 jam.</p>
    </div>
  </div>

  <div id='other-prizes-div-holder' class='hidden'>
    <p>Apakah Anda Pemenang Apple Macbook Pro, Kamera Fujifilm X-M1, Lenovo Phab Plus, dan Meizu
      M2?</p>
  </div>

  <div id='congratulations-holder' class='hidden'>
    <p>Bagi Anda yang belum beruntung, masih ada kesempatan menang di promo #MyBigWish periode 2
      (pembelanjaan 11 - 31 Des 2015).<br>
      Terima kasih dan terus belanja di Blibli.com!</p>
  </div>
  <input type="button" class="hidden" id="playslot-wrapper" value="">
  <input type="button" class="hidden" id="play-congrats-slot-wrapper" value="">

</div>
<script src="_asset/js/jquery.easing.1.3.js" type="text/javascript" charset="utf-8"></script>
<script src="_asset/js/jquery.jSlots.min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">

  $(document).ready(function () {

    var chosenWinnerStateEnum = ["", "Satu", "Dua", "Tiga", "Empat", "Lima"];
    var regionGrandPrizeStateEnum = ["Pertama", "Kedua", "Ketiga", "Keempat", "Kelima"];
    var SLOT_INTERVAL = 20;
    var UNILEVER_SLOT_INTERVAL = 500;

    var CHOSEN_WINNER = $('#chosen-winner');
    var RUNNING = $('#running');
    var RUNNING_RERUN = $('#running-rerun');
    var CLAIMING = $('#claiming');
    var CLAIMED = $('#claimed');
    var OTHERS = $('#other-prizes-div-holder');
    var CONGRATULATIONS = $('#congratulations-holder');
    var displayCodePart1 = [1, 2, 3, 4, 5];
    var displayCodePart2 = [6, 7, 8, 9, 10];
    var unileverValue = [1];
    var nameHolder = $('#jpn-name-holder');
    var hasRunOnce = false;

    $("#congratulations-slot").jSlots({
      number: 16,
      winnerNumber: 1,
      spinner: '#play-congrats-slot-wrapper',
      easing: 'easeOutSine',
      time: 3000,
      loops: 3,
      endNumbers: [4, 16, 15, 8, 19, 2, 21, 22, 13, 2, 21, 10, 16, 15, 20, 28]
    });

    $('.slot-wrapper #code-slot1').jSlots({
      number: 5,
      winnerNumber: 1,
      spinner: '#playslot-wrapper',
      easing: 'easeOutSine',
      time: SLOT_INTERVAL,
      loops: 1,
      endNumbers: displayCodePart1
    });

    $('.slot-wrapper #code-slot2').jSlots({
      number: 5,
      winnerNumber: 1,
      spinner: '#playslot-wrapper',
      easing: 'easeOutSine',
      time: SLOT_INTERVAL,
      loops: 1,
      endNumbers: displayCodePart2
    });

    $('#unilever-slot').jSlots({
      number: 1,
      winnerNumber: 1,
      spinner: '#playslot-wrapper',
      easing: 'easeOutSine',
      time: UNILEVER_SLOT_INTERVAL / 4,
      loops: 1,
      endNumbers: unileverValue
    });

    function getCurrent(voucherCode, name) {
      console.log(voucherCode + ", " + name);
      var codeParts = voucherCode.split("-");
      var jpnOrJpnu = codeParts[0];

      if (jpnOrJpnu.length > 3) {
        unileverValue[0] = 2;
      } else {
        unileverValue[0] = 1;
      }

      parseCode(codeParts[1], displayCodePart1);
      parseCode(codeParts[2], displayCodePart2);

      currentName = name;
    }

    function parseCode(voucherCode, destination) {
      for (i = 0; i < 5; i++) {
        var charAtIdx = voucherCode.charAt(i).toUpperCase();

        if (charAtIdx == '0') {
          charAtIdx = 10;
        } else if (charAtIdx == '*') {
          charAtIdx = 11;
        } else if (charAtIdx >= 'A' && charAtIdx <= 'Z') {
          charAtIdx = charAtIdx.charCodeAt(0) - "A".charCodeAt(0) + 12;
        }
        destination[i] = charAtIdx;
      }
      console.log(destination);
    }

    function hide(el) {
      if (el.css("display") != "none") {
        el.css("display", "none");
      }
    }

    function showElement(element) {
      element.removeClass("hidden");
      element.css("display", "block");
    }

    function runSlot() {
      $('#playslot-wrapper').click();
      nameHolder.html(currentName);
    }

    function startWS() {
      var wsProtocol = "";
      if (useWss === 'true') {
        wsProtocol = "wss://";
      } else {
        wsProtocol = "ws://";
      }
      ws = new ReconnectingWebSocket(wsProtocol + viewHost + "/luckyDip", null, {reconnectInterval: 1000});
      ws.onmessage = function (message) {
        onMessageWS(message);
      }
    }

    function onMessageWS(message) {

      if(message.data.gameState == "END"){
        window.location = "/";
      }

      //{"name":"dadang sapari","voucherCode":"JPN-FQ6DT-***J4","gameState":"WAITING","isTheFirst":false,"regionCounter":0}
      var data = JSON.parse(message.data);
      var name = data.name;
      var voucherCode = data.voucherCode;
      var gameState = data.gameState;
      var isTheFirst = data.isTheFirst;
      var regionCounter = data.regionCounter;
      var timeLeftToClaim = data.timeLeftToClaim;
      showAndHideParts(name, voucherCode, gameState, isTheFirst, regionCounter, timeLeftToClaim);
      // console.log(message);
    }

    function hideAllBut(elem) {
      hide(CHOSEN_WINNER);
      hide(RUNNING);
      hide(RUNNING_RERUN);
      hide(CLAIMING);
      hide(CLAIMED);
      hide(OTHERS);
      hide(CONGRATULATIONS);

      showElement(elem);
    }

    function showAndHideParts(name, voucherCode, gameState, isTheFirst, regionCounter,
                              timeLeftToClaim) {
      setTimer((300 - timeLeftToClaim), $('#claiming-countdown'));
      console.log(gameState);

      switch (gameState) {
        case "RUNNING" :
        {
          hasRunOnce = false;
          if (isTheFirst) {
            hideAllBut(RUNNING);
          } else {
            hideAllBut(RUNNING_RERUN);
          }
          $("#grand-prize-state").html(regionGrandPrizeStateEnum[regionCounter]);
          $("#rerun-th").html(regionGrandPrizeStateEnum[regionCounter]);
          getCurrent(voucherCode, name);
          runSlot();
          break;
        }
        case "WAITING" :
        {
          hideAllBut(CLAIMING);
          if (!hasRunOnce) {
            getCurrent(voucherCode, name);
            runSlot();
            hasRunOnce = true;
          }

          break;
        }
        case "END" :
        {
          break;
        }
      }
      if (regionCounter > 0) {
        showElement(CHOSEN_WINNER);
        $("chosen-winner-state").html(chosenWinnerStateEnum[regionCounter]);
      }
    }

    function setTimer(seconds, selector) {
      var finalDisplayTime = "";
      var day = Math.floor(seconds / (3600 * 24));
      var hour = Math.floor((seconds / 3600) % 24);
      var min = Math.floor((seconds / 60) % 60);
      var sec = Math.floor(seconds % 60);

      finalDisplayTime += showOrHideTimerPart(day, "hari");
      finalDisplayTime += showOrHideTimerPart(hour, "jam");
      finalDisplayTime += showOrHideTimerPart(min, "menit");
      finalDisplayTime += showOrHideTimerPart(sec, "detik");

      if (finalDisplayTime == "") {
        finalDisplayTime = "&nbsp;"
      }

      selector.html(finalDisplayTime);
    }
    function showOrHideTimerPart(part, partString) {
      if (part > 0) {
        return part + " " + partString + " ";
      }
      return "";
    }



    startWS();
  });
</script>
